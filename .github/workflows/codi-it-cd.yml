- name: Restart app on EC2 (debug mode)
  uses: appleboy/ssh-action@master
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_PRIVATE_KEY }}
    script: |
      set -e
      set -x
      trap 'echo "ERROR: failed at line $LINENO"; exit 1' ERR

      echo "STEP 1: cd to project"
      cd /home/ec2-user/codi-it

      echo "STEP 2: write .env"
      cat > .env << EOF
      DATABASE_URL=${{ secrets.DATABASE_URL }}
      JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
      JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
      AWS_REGION=${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_BUCKET_NAME=${{ secrets.AWS_BUCKET_NAME }}
      FRONTEND_URL=${{ secrets.FRONTEND_URL }}
      EOF

      echo "STEP 3: npm ci"
      time npm ci

      echo "STEP 4: npx prisma generate"
      time npx prisma generate

      echo "STEP 5: npx prisma db push --accept-data-loss"
      time npx prisma db push --accept-data-loss

      echo "STEP 6: mkdir logs and pm2 restart/start"
      mkdir -p /home/ec2-user/logs
      time pm2 restart all || pm2 start ecosystem.config.js
      pm2 save

      echo "STEP 7: nginx copy, restart"
      sudo cp ./nginx/nginx.conf /etc/nginx/conf.d/codi-it-proxy.conf
      sudo nginx -t
      sudo systemctl restart nginx

      echo "DONE: all steps finished"
